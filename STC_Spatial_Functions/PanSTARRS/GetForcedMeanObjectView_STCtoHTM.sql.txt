DROP FUNCTION IF EXISTS [dbo].[fGetNearbyForcedMeanObjectViewTAP]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [dbo].[fGetNearbyForcedMeanObjectViewTAP] (@STSCCircle varchar(max))

/*
select * From fGetNearbyForcedMeanObjectViewTAP('CIRCLE 204.23963702 -29.875292 0.01667')
select * From fGetNearbyForcedMeanObjectViewTAP('CIRCLE 204.23963702 -29.875292 0.01667')
where nDetections > 5
*/

RETURNS @ReturnTable TABLE (
	[objName] [varchar](32) NOT NULL,
	[objAltName1] [varchar](32) NOT NULL,
	[objAltName2] [varchar](32) NOT NULL,
	[objAltName3] [varchar](32) NOT NULL,
	[objID] [bigint] NOT NULL,
	[uniquePspsOBid] [bigint] NOT NULL,
	[ippObjID] [bigint] NOT NULL,
	[surveyID] [tinyint] NOT NULL,
	[htmID] [bigint] NOT NULL,
	[zoneID] [int] NOT NULL,
	[tessID] [tinyint] NOT NULL,
	[projectionID] [smallint] NOT NULL,
	[skyCellID] [tinyint] NOT NULL,
	[randomID] [float] NOT NULL,
	[batchID] [bigint] NOT NULL,
	[dvoRegionID] [int] NOT NULL,
	[processingVersion] [tinyint] NOT NULL,
	[objInfoFlag] [int] NOT NULL,
	[qualityFlag] [tinyint] NOT NULL,
	[raStack] [float] NOT NULL,
	[decStack] [float] NOT NULL,
	[raStackErr] [real] NOT NULL,
	[decStackErr] [real] NOT NULL,
	[raMean] [float] NOT NULL,
	[decMean] [float] NOT NULL,
	[raMeanErr] [real] NOT NULL,
	[decMeanErr] [real] NOT NULL,
	[epochMean] [float] NOT NULL,
	[posMeanChisq] [real] NOT NULL,
	[cx] [float] NOT NULL,
	[cy] [float] NOT NULL,
	[cz] [float] NOT NULL,
	[lambda] [float] NOT NULL,
	[beta] [float] NOT NULL,
	[l] [float] NOT NULL,
	[b] [float] NOT NULL,
	[nStackObjectRows] [smallint] NOT NULL,
	[nStackDetections] [smallint] NOT NULL,
	[nDetections] [smallint] NOT NULL,
	[ng] [smallint] NOT NULL,
	[nr] [smallint] NOT NULL,
	[ni] [smallint] NOT NULL,
	[nz] [smallint] NOT NULL,
	[ny] [smallint] NOT NULL,
	[gnTotal] [smallint] NOT NULL,
	[gnIncPSFFlux] [smallint] NOT NULL,
	[gnIncKronFlux] [smallint] NOT NULL,
	[gnIncApFlux] [smallint] NOT NULL,
	[gnIncR5] [smallint] NOT NULL,
	[gnIncR6] [smallint] NOT NULL,
	[gnIncR7] [smallint] NOT NULL,
	[gFPSFFlux] [real] NOT NULL,
	[gFPSFFluxErr] [real] NOT NULL,
	[gFPSFFluxStd] [real] NOT NULL,
	[gFKronFlux] [real] NOT NULL,
	[gFKronFluxErr] [real] NOT NULL,
	[gFKronFluxStd] [real] NOT NULL,
	[gFApFlux] [real] NOT NULL,
	[gFApFluxErr] [real] NOT NULL,
	[gFApFluxStd] [real] NOT NULL,
	[gFmeanflxR5] [real] NOT NULL,
	[gFmeanflxR5Err] [real] NOT NULL,
	[gFmeanflxR5Std] [real] NOT NULL,
	[gFmeanflxR5Fill] [real] NOT NULL,
	[gFmeanflxR6] [real] NOT NULL,
	[gFmeanflxR6Err] [real] NOT NULL,
	[gFmeanflxR6Std] [real] NOT NULL,
	[gFmeanflxR6Fill] [real] NOT NULL,
	[gFmeanflxR7] [real] NOT NULL,
	[gFmeanflxR7Err] [real] NOT NULL,
	[gFmeanflxR7Std] [real] NOT NULL,
	[gFmeanflxR7Fill] [real] NOT NULL,
	[gFlags] [int] NOT NULL,
	[gE1] [real] NOT NULL,
	[gE2] [real] NOT NULL,
	[rnTotal] [smallint] NOT NULL,
	[rnIncPSFFlux] [smallint] NOT NULL,
	[rnIncKronFlux] [smallint] NOT NULL,
	[rnIncApFlux] [smallint] NOT NULL,
	[rnIncR5] [smallint] NOT NULL,
	[rnIncR6] [smallint] NOT NULL,
	[rnIncR7] [smallint] NOT NULL,
	[rFPSFFlux] [real] NOT NULL,
	[rFPSFFluxErr] [real] NOT NULL,
	[rFPSFFluxStd] [real] NOT NULL,
	[rFKronFlux] [real] NOT NULL,
	[rFKronFluxErr] [real] NOT NULL,
	[rFKronFluxStd] [real] NOT NULL,
	[rFApFlux] [real] NOT NULL,
	[rFApFluxErr] [real] NOT NULL,
	[rFApFluxStd] [real] NOT NULL,
	[rFmeanflxR5] [real] NOT NULL,
	[rFmeanflxR5Err] [real] NOT NULL,
	[rFmeanflxR5Std] [real] NOT NULL,
	[rFmeanflxR5Fill] [real] NOT NULL,
	[rFmeanflxR6] [real] NOT NULL,
	[rFmeanflxR6Err] [real] NOT NULL,
	[rFmeanflxR6Std] [real] NOT NULL,
	[rFmeanflxR6Fill] [real] NOT NULL,
	[rFmeanflxR7] [real] NOT NULL,
	[rFmeanflxR7Err] [real] NOT NULL,
	[rFmeanflxR7Std] [real] NOT NULL,
	[rFmeanflxR7Fill] [real] NOT NULL,
	[rFlags] [int] NOT NULL,
	[rE1] [real] NOT NULL,
	[rE2] [real] NOT NULL,
	[inTotal] [smallint] NOT NULL,
	[inIncPSFFlux] [smallint] NOT NULL,
	[inIncKronFlux] [smallint] NOT NULL,
	[inIncApFlux] [smallint] NOT NULL,
	[inIncR5] [smallint] NOT NULL,
	[inIncR6] [smallint] NOT NULL,
	[inIncR7] [smallint] NOT NULL,
	[iFPSFFlux] [real] NOT NULL,
	[iFPSFFluxErr] [real] NOT NULL,
	[iFPSFFluxStd] [real] NOT NULL,
	[iFKronFlux] [real] NOT NULL,
	[iFKronFluxErr] [real] NOT NULL,
	[iFKronFluxStd] [real] NOT NULL,
	[iFApFlux] [real] NOT NULL,
	[iFApFluxErr] [real] NOT NULL,
	[iFApFluxStd] [real] NOT NULL,
	[iFmeanflxR5] [real] NOT NULL,
	[iFmeanflxR5Err] [real] NOT NULL,
	[iFmeanflxR5Std] [real] NOT NULL,
	[iFmeanflxR5Fill] [real] NOT NULL,
	[iFmeanflxR6] [real] NOT NULL,
	[iFmeanflxR6Err] [real] NOT NULL,
	[iFmeanflxR6Std] [real] NOT NULL,
	[iFmeanflxR6Fill] [real] NOT NULL,
	[iFmeanflxR7] [real] NOT NULL,
	[iFmeanflxR7Err] [real] NOT NULL,
	[iFmeanflxR7Std] [real] NOT NULL,
	[iFmeanflxR7Fill] [real] NOT NULL,
	[iFlags] [int] NOT NULL,
	[iE1] [real] NOT NULL,
	[iE2] [real] NOT NULL,
	[znTotal] [smallint] NOT NULL,
	[znIncPSFFlux] [smallint] NOT NULL,
	[znIncKronFlux] [smallint] NOT NULL,
	[znIncApFlux] [smallint] NOT NULL,
	[znIncR5] [smallint] NOT NULL,
	[znIncR6] [smallint] NOT NULL,
	[znIncR7] [smallint] NOT NULL,
	[zFPSFFlux] [real] NOT NULL,
	[zFPSFFluxErr] [real] NOT NULL,
	[zFPSFFluxStd] [real] NOT NULL,
	[zFKronFlux] [real] NOT NULL,
	[zFKronFluxErr] [real] NOT NULL,
	[zFKronFluxStd] [real] NOT NULL,
	[zFApFlux] [real] NOT NULL,
	[zFApFluxErr] [real] NOT NULL,
	[zFApFluxStd] [real] NOT NULL,
	[zFmeanflxR5] [real] NOT NULL,
	[zFmeanflxR5Err] [real] NOT NULL,
	[zFmeanflxR5Std] [real] NOT NULL,
	[zFmeanflxR5Fill] [real] NOT NULL,
	[zFmeanflxR6] [real] NOT NULL,
	[zFmeanflxR6Err] [real] NOT NULL,
	[zFmeanflxR6Std] [real] NOT NULL,
	[zFmeanflxR6Fill] [real] NOT NULL,
	[zFmeanflxR7] [real] NOT NULL,
	[zFmeanflxR7Err] [real] NOT NULL,
	[zFmeanflxR7Std] [real] NOT NULL,
	[zFmeanflxR7Fill] [real] NOT NULL,
	[zFlags] [int] NOT NULL,
	[zE1] [real] NOT NULL,
	[zE2] [real] NOT NULL,
	[ynTotal] [smallint] NOT NULL,
	[ynIncPSFFlux] [smallint] NOT NULL,
	[ynIncKronFlux] [smallint] NOT NULL,
	[ynIncApFlux] [smallint] NOT NULL,
	[ynIncR5] [smallint] NOT NULL,
	[ynIncR6] [smallint] NOT NULL,
	[ynIncR7] [smallint] NOT NULL,
	[yFPSFFlux] [real] NOT NULL,
	[yFPSFFluxErr] [real] NOT NULL,
	[yFPSFFluxStd] [real] NOT NULL,
	[yFKronFlux] [real] NOT NULL,
	[yFKronFluxErr] [real] NOT NULL,
	[yFKronFluxStd] [real] NOT NULL,
	[yFApFlux] [real] NOT NULL,
	[yFApFluxErr] [real] NOT NULL,
	[yFApFluxStd] [real] NOT NULL,
	[yFmeanflxR5] [real] NOT NULL,
	[yFmeanflxR5Err] [real] NOT NULL,
	[yFmeanflxR5Std] [real] NOT NULL,
	[yFmeanflxR5Fill] [real] NOT NULL,
	[yFmeanflxR6] [real] NOT NULL,
	[yFmeanflxR6Err] [real] NOT NULL,
	[yFmeanflxR6Std] [real] NOT NULL,
	[yFmeanflxR6Fill] [real] NOT NULL,
	[yFmeanflxR7] [real] NOT NULL,
	[yFmeanflxR7Err] [real] NOT NULL,
	[yFmeanflxR7Std] [real] NOT NULL,
	[yFmeanflxR7Fill] [real] NOT NULL,
	[yFlags] [int] NOT NULL,
	[yE1] [real] NOT NULL,
	[yE2] [real] NOT NULL,
	[distance] [float] NOT NULL
)
AS 
BEGIN
	DECLARE @ra float;
	DECLARE @dec float;
	DECLARE @theta float;
	DECLARE @STCSTable TABLE (STCSString varchar(max))
	DECLARE @valueTable TABLE (theValue varchar(32), rowNumber int identity(1,1))

	insert into @STCSTable (STCSString) values (@STSCCircle)
	insert into @valueTable (theValue)
	select value
	from @STCSTable
	cross apply string_split(STCSString,' ')

	select @ra=cast(theValue as float) from @valueTable where rowNumber=2
	select @dec=cast(theValue as float) from @valueTable where rowNumber=3
	select @theta=cast(theValue as float) from @valueTable where rowNumber=4

    INSERT INTO @ReturnTable
    SELECT m.*, nb.distance
    FROM fHtmGetNearbyObjEq(@ra, @dec, @theta) as nb
	inner join ForcedMeanObjectView as m on nb.objid=m.objid
    RETURN
END
GO


